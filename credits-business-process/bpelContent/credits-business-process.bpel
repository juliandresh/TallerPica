<!-- credits-business-process BPEL Process [Generated by the Eclipse BPEL 
	Designer] -->
<!-- Date: Mon Mar 05 12:13:11 IST 2012 -->
<bpel:process name="credits-business-process"
	targetNamespace="http://javeriana-credits/bpel-engine/services"
	suppressJoinFailure="yes" xmlns:tns="http://javeriana-credits/bpel-engine/services"
	xmlns:brms="http://javeriana-credits/brms" xmlns:es="http://javeriana-credits/enterprise-services"
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable">

	<!-- Import the client WSDL -->

	<bpel:import location="credits-business-processArtifacts.wsdl"
		namespace="http://javeriana-credits/bpel-engine/services" importType="http://schemas.xmlsoap.org/wsdl/" />

	<bpel:import location="providers/business_rule.wsdl"
		namespace="http://javeriana-credits/brms" importType="http://schemas.xmlsoap.org/wsdl/" />

	<bpel:import location="providers/credits_enterprise_service.wsdl"
		namespace="http://javeriana-credits/enterprise-services" importType="http://schemas.xmlsoap.org/wsdl/" />

	<!-- ================================================================= -->
	<!-- PARTNERLINKS -->
	<!-- List of services participating in this BPEL process -->
	<!-- ================================================================= -->

	<bpel:partnerLinks>
		<!-- The 'client' role represents the requester of this service. -->
		<bpel:partnerLink name="client" partnerLinkType="tns:credits-business-process"
			myRole="credits-business-processProvider" />

		<bpel:partnerLink name="businessRuleServicePartnerLink"
			partnerLinkType="brms:businessRulePortType_PLT" partnerRole="businessRulePortType_Role"
			initializePartnerRole="yes" />

		<bpel:partnerLink name="creditsEnterpriseServicePartnerLink"
			partnerLinkType="es:creditsEnterprisePortType_PLT" partnerRole="creditsEnterprisePortType_Role"
			initializePartnerRole="yes" />

	</bpel:partnerLinks>



	<!-- ================================================================= -->
	<!-- VARIABLES -->
	<!-- List of messages and XML documents used within this BPEL process -->
	<!-- ================================================================= -->
	<bpel:variables>
		<!-- Reference to the message passed as input during initiation -->
		<bpel:variable name="input"
			messageType="tns:credits-business-processRequestMessage" />

		<!-- Reference to the message that will be returned to the requester -->
		<bpel:variable name="output"
			messageType="tns:credits-business-processResponseMessage" />
		<bpel:variable name="brms_input" messageType="brms:evaluateRuleRequest"></bpel:variable>
		<bpel:variable name="brms_output" messageType="brms:evaluateRuleResponse"></bpel:variable>
		<bpel:variable name="crear_credito_input" messageType="es:crearCreditoRequest"></bpel:variable>



		<bpel:variable name="crear_credito_output" messageType="es:crearCreditoResponse"></bpel:variable>
		<bpel:variable name="rechazar_credito_input"
			messageType="es:notificarRechazoRequest"></bpel:variable>
		<bpel:variable name="rechazar_credito_output"
			messageType="es:notificarRechazoResponse"></bpel:variable>
	</bpel:variables>

	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:sequence name="main">

		<!-- Receive input from requester. Note: This maps to operation defined 
			in credits-business-process.wsdl -->
		<bpel:receive name="receiveInput" partnerLink="client"
			portType="tns:credits-business-process" operation="process" variable="input"
			createInstance="yes" />

		<!-- Generate reply to synchronous request -->
		<bpel:assign validate="no" name="assign-brms-input">
			<bpel:copy>
				<bpel:from>
                    <bpel:literal><tns:evaluateRule xmlns:tns="http://javeriana-credits/brms" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:ValidarCreditoFact>
    <tipo>tipo</tipo>
    <fuelPercentage>0</fuelPercentage>
    <aprobado>true</aprobado>
  </tns:ValidarCreditoFact>
</tns:evaluateRule></bpel:literal>
                </bpel:from>
				<bpel:to variable="brms_input" part="parameters"></bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[$input.payload/tns:tipo]]>
				</bpel:from>
				<bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[$brms_input.parameters/brms:ValidarCreditoFact/tipo]]>
				</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[$input.payload/tns:monto]]>
				</bpel:from>
				<bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[$brms_input.parameters/brms:ValidarCreditoFact/monto]]>
				</bpel:to>
			</bpel:copy>
		</bpel:assign>
		<bpel:invoke name="invoke-brms-service" partnerLink="businessRuleServicePartnerLink"
			operation="evaluateRule" portType="brms:businessRulePortType"
			inputVariable="brms_input" outputVariable="brms_output"></bpel:invoke>
		<bpel:if name="If">
			<bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$brms_output.parameters/brms:ValidarCreditoFact/aprobado = 'true']]></bpel:condition>
			<bpel:sequence name="Sequence">
				<bpel:assign validate="no" name="assign-crear-credito">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:crearCredito xmlns:tns="http://javeriana-credits/enterprise-services"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tipo>tipo</tipo>
									<monto>0</monto>
									<usuario>usuario</usuario>
								</tns:crearCredito>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="crear_credito_input" part="parameters"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[$input.payload/tns:tipo]]>
						</bpel:from>
						<bpel:to part="parameters" variable="crear_credito_input">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tipo]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[$input.payload/tns:monto]]>
						</bpel:from>
						<bpel:to part="parameters" variable="crear_credito_input">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[monto]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[$input.payload/tns:usuario]]>
						</bpel:from>
						<bpel:to part="parameters" variable="crear_credito_input">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[usuario]]></bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:invoke name="invoke-crear-credito" partnerLink="creditsEnterpriseServicePartnerLink"
					operation="crearCredito" portType="es:creditsEnterprisePortType"
					inputVariable="crear_credito_input" outputVariable="crear_credito_output"></bpel:invoke>
				<bpel:assign validate="no" name="assign-response-approved">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:credits-business-processResponse
									xmlns:tns="http://javeriana-credits/bpel-engine/services"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:aprobado>true</tns:aprobado>
									<tns:descripcion>credito aprobado</tns:descripcion>
								</tns:credits-business-processResponse>
							</bpel:literal>
						</bpel:from>
						<bpel:to part="payload" variable="output"></bpel:to>
					</bpel:copy>
				</bpel:assign>
			</bpel:sequence>
			<bpel:else>
				<bpel:sequence name="Sequence1">
					<bpel:assign validate="no" name="assign-rechazar-credito">
						<bpel:copy>
							<bpel:from>
								<bpel:literal>
									<tns:notificarRechazo
										xmlns:tns="http://javeriana-credits/enterprise-services"
										xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<tipo>tipo</tipo>
										<monto>0</monto>
										<usuario>usuario</usuario>
									</tns:notificarRechazo>
								</bpel:literal>
							</bpel:from>
							<bpel:to variable="rechazar_credito_input" part="parameters"></bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$input.payload/tns:tipo]]>
							</bpel:from>
							<bpel:to part="parameters" variable="rechazar_credito_input">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tipo]]></bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$input.payload/tns:monto]]>
							</bpel:from>
							<bpel:to part="parameters" variable="rechazar_credito_input">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[monto]]></bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$input.payload/tns:usuario]]>
							</bpel:from>
							<bpel:to part="parameters" variable="rechazar_credito_input">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[usuario]]></bpel:query>
							</bpel:to>
						</bpel:copy>
					</bpel:assign>
					<bpel:invoke name="iInvoke-rechazar-credito"
						partnerLink="creditsEnterpriseServicePartnerLink" operation="notificarRechazo"
						portType="es:creditsEnterprisePortType" inputVariable="rechazar_credito_input"
						outputVariable="rechazar_credito_output"></bpel:invoke>
					<bpel:assign validate="no" name="assign-response-rejected">
						<bpel:copy>
							<bpel:from>
								<bpel:literal>
									<tns:credits-business-processResponse
										xmlns:tns="http://javeriana-credits/bpel-engine/services"
										xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<tns:aprobado>false</tns:aprobado>
										<tns:descripcion>credito rechazado</tns:descripcion>
									</tns:credits-business-processResponse>
								</bpel:literal>
							</bpel:from>
							<bpel:to part="payload" variable="output"></bpel:to>
						</bpel:copy>
					</bpel:assign>
				</bpel:sequence>
			</bpel:else>
		</bpel:if>

		<bpel:reply name="replyOutput" partnerLink="client"
			portType="tns:credits-business-process" operation="process" variable="output" />
	</bpel:sequence>
</bpel:process>

